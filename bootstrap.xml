<?xml version="1.0" encoding="utf-8" ?>
<gsh:script
	xmlns:gsh="http://vcgr.cs.virginia.edu/genii/xsh/script"
	xmlns:geniix="http://vcgr.cs.virginia.edu/genii/xsh/grid">

	<gsh:define name="BOOT_SRVS"
		source="/containers/BootstrapContainer/Services"/>
	
	<geniix:login>
		<gsh:param>--no-gui</gsh:param>
		<gsh:param>--file=deployments/default/security/keys.pfx</gsh:param>
		<gsh:param>--password=keys</gsh:param>
		<gsh:param>skynet</gsh:param>
	</geniix:login>
	
	<gsh:echo
		message="Creating Root of RNS space."/>
	<geniix:create-rns-root>
		<gsh:param>--protocol=https</gsh:param>
		<gsh:param>--host=localhost</gsh:param>
		<gsh:param>--port=18080</gsh:param>
		<gsh:param>context.xml</gsh:param>
	</geniix:create-rns-root>

	<geniix:mkdir>
		<gsh:param>/containers</gsh:param>
	</geniix:mkdir>
	
	<geniix:ln>
		<gsh:param>--service-url=https://localhost:18080/axis/services/VCGRContainerPortType</gsh:param>
		<gsh:param>/containers/BootstrapContainer</gsh:param>
	</geniix:ln>

	<gsh:echo
		message="Setting permissions for bootstrap directories and serviecs"/>
	<geniix:gaml-chmod>
		<gsh:param>/</gsh:param>
		<gsh:param>+r</gsh:param>
		<gsh:param>--everyone</gsh:param>
	</geniix:gaml-chmod>

	<geniix:gaml-chmod>
		<gsh:param>/containers</gsh:param>
		<gsh:param>+r</gsh:param>
		<gsh:param>--everyone</gsh:param>
	</geniix:gaml-chmod>

	<gsh:echo message="Forming general directory structure."/>
	<geniix:mkdir>
		<gsh:param>/bes-containers</gsh:param>
		<gsh:param>/schedulers</gsh:param>
		<gsh:param>/users</gsh:param>
		<gsh:param>/groups</gsh:param>
		<gsh:param>/home</gsh:param>
	</geniix:mkdir>

	<geniix:gaml-chmod>
		<gsh:param>/bes-containers</gsh:param>
		<gsh:param>+r</gsh:param>
		<gsh:param>--everyone</gsh:param>
	</geniix:gaml-chmod>

	<geniix:gaml-chmod>
		<gsh:param>/schedulers</gsh:param>
		<gsh:param>+r</gsh:param>
		<gsh:param>--everyone</gsh:param>
	</geniix:gaml-chmod>

	<geniix:gaml-chmod>
		<gsh:param>/users</gsh:param>
		<gsh:param>+r</gsh:param>
		<gsh:param>--everyone</gsh:param>
	</geniix:gaml-chmod>

	<geniix:gaml-chmod>
		<gsh:param>/groups</gsh:param>
		<gsh:param>+r</gsh:param>
		<gsh:param>--everyone</gsh:param>
	</geniix:gaml-chmod>

	<geniix:gaml-chmod>
		<gsh:param>/home</gsh:param>
		<gsh:param>+r</gsh:param>
		<gsh:param>--everyone</gsh:param>
	</geniix:gaml-chmod>

	<geniix:create-resource>
		<gsh:param>${BOOT_SRVS}/BasicSchedulerPortType</gsh:param>
		<gsh:param>/schedulers/BootstrapScheduler</gsh:param>
	</geniix:create-resource>

	<geniix:gaml-chmod>
		<gsh:param>/schedulers/BootstrapScheduler</gsh:param>
		<gsh:param>+r</gsh:param>
		<gsh:param>--everyone</gsh:param>
	</geniix:gaml-chmod>
	
	<gsh:echo message="Adding groups"/>
	<gsh:foreach param-name="FILE" source-dir="certs/groups"
		filter="^.*\.cer$">

		<gsh:define name="GROUP" source="${FILE}"
			pattern="\.cer" replacement="" global="true"/>
		
		<gsh:echo message="Adding group ${GROUP}"/>
		<geniix:cp>
			<gsh:param>--local-src</gsh:param>
			<gsh:param>certs/groups/${FILE}</gsh:param>
			<gsh:param>/groups/${GROUP}</gsh:param>
		</geniix:cp>

		<geniix:gaml-chmod>
			<gsh:param>/groups/${GROUP}</gsh:param>
			<gsh:param>+r</gsh:param>
			<gsh:param>--everyone</gsh:param>
		</geniix:gaml-chmod>
	</gsh:foreach>

	<gsh:echo message="Adding users"/>
	<gsh:foreach param-name="FILE" source-dir="certs/users"
		filter="^.*\.cer$">
		
		<gsh:define name="USER" source="${FILE}"
			pattern="\.cer" replacement="" global="true"/>
		
		<gsh:echo message="Adding user ${USER}"/>
		<geniix:cp>
			<gsh:param>--local-src</gsh:param>
			<gsh:param>certs/users/${FILE}</gsh:param>
			<gsh:param>/users/${USER}</gsh:param>
		</geniix:cp>

		<geniix:gaml-chmod>
			<gsh:param>/users/${USER}</gsh:param>
			<gsh:param>+r</gsh:param>
			<gsh:param>--everyone</gsh:param>
		</geniix:gaml-chmod>
		
		<geniix:mkdir>
			<gsh:param>/home/${USER}</gsh:param>
		</geniix:mkdir>
		
		<geniix:gaml-chmod>
			<gsh:param>/home/${USER}</gsh:param>
			<gsh:param>+r+w+x</gsh:param>
			<gsh:param>/users/${USER}</gsh:param>
		</geniix:gaml-chmod>
		
		<geniix:gaml-chmod>
			<gsh:param>/home/${USER}</gsh:param>
			<gsh:param>+r</gsh:param>
			<gsh:param>--everyone</gsh:param>
		</geniix:gaml-chmod>
	</gsh:foreach>
	
	<gsh:echo message="Adding machines"/>
	<gsh:foreach param-name="URL" source-file="machines">

		<gsh:define name="MACHINE" source="${URL}"
			pattern="^https?://" replacement="" global="true"/>
		<gsh:define name="MACHINE" source="${MACHINE}"
			pattern=":.+$" replacement="" global="true"/>

		<gsh:echo message="Adding machine ${MACHINE}"/>
		<geniix:attach-host>
			<gsh:param>${URL}/axis/services/VCGRContainerPortType</gsh:param>
			<gsh:param>/containers/${MACHINE}</gsh:param>
		</geniix:attach-host>
	</gsh:foreach>

	<gsh:echo message="Setting security on containers/services"/>	
	<gsh:foreach param-name="CONTAINER" source-rns="/containers">
		<gsh:echo message="Setting security on container ${CONTAINER}"/>	
		<geniix:gaml-chmod>
			<gsh:param>/containers/${CONTAINER}</gsh:param>
			<gsh:param>+r</gsh:param>
			<gsh:param>--everyone</gsh:param>
		</geniix:gaml-chmod>

		<geniix:gaml-chmod>
			<gsh:param>/containers/${CONTAINER}/Services</gsh:param>
			<gsh:param>+r</gsh:param>
			<gsh:param>--everyone</gsh:param>
		</geniix:gaml-chmod>

		<gsh:foreach param-name="SERVICE"
			source-rns="/containers/${CONTAINER}/Services">
			<gsh:echo message="Setting security on ${SERVICE} in container ${CONTAINER}"/>
			<geniix:gaml-chmod>
				<gsh:param>/containers/${CONTAINER}/Services/${SERVICE}</gsh:param>
				<gsh:param>+r</gsh:param>
				<gsh:param>--everyone</gsh:param>
			</geniix:gaml-chmod>

			<gsh:foreach param-name="GROUP" source-rns="/groups">
				<geniix:gaml-chmod>
					<gsh:param>/containers/${CONTAINER}/Services/${SERVICE}</gsh:param>
					<gsh:param>+r+x</gsh:param>
					<gsh:param>/groups/${GROUP}</gsh:param>
				</geniix:gaml-chmod>
			</gsh:foreach>
		</gsh:foreach>

		<gsh:echo message="Creating BES resource for ${CONTAINER}."/>
		<geniix:create-resource>
			<gsh:param>/containers/${CONTAINER}/Services/BESPortType</gsh:param>
			<gsh:param>/bes-containers/${CONTAINER}</gsh:param>
		</geniix:create-resource>

		<geniix:gaml-chmod>
			<gsh:param>/bes-containers/${CONTAINER}</gsh:param>
			<gsh:param>+r</gsh:param>
			<gsh:param>--everyone</gsh:param>
		</geniix:gaml-chmod>

		<gsh:echo message="Linking bes ${CONTAINER} into scheduler"/>
		<geniix:ln>
			<gsh:param>/bes-containers/${CONTAINER}</gsh:param>
			<gsh:param>/schedulers/BootstrapScheduler/${CONTAINER}</gsh:param>
		</geniix:ln>
		
		<gsh:echo message="Setting deployer for bes ${CONTAINER}."/>
		<geniix:set-deployers>
			<gsh:param>/bes-containers/${CONTAINER}</gsh:param>
			<gsh:param>/containers/${CONTAINER}/Services/ApplicationDeployerPortType</gsh:param>
		</geniix:set-deployers>

		<gsh:foreach param-name="GROUP" source-rns="/groups">
			<geniix:gaml-chmod>
				<gsh:param>/bes-containers/${CONTAINER}</gsh:param>
				<gsh:param>+r+x</gsh:param>
				<gsh:param>/groups/${GROUP}</gsh:param>
			</geniix:gaml-chmod>
		</gsh:foreach>
	</gsh:foreach>

	<gsh:foreach param-name="GROUP" source-rns="/groups">
		<gsh:echo message="Adding group ${GROUP} to +x for scheduler"/>
		<geniix:gaml-chmod>
			<gsh:param>/schedulers/BootstrapScheduler</gsh:param>
			<gsh:param>+r+x</gsh:param>
			<gsh:param>/groups/${GROUP}</gsh:param>
		</geniix:gaml-chmod>
	</gsh:foreach>
	
	<gsh:echo message="Logging out"/>
	<geniix:logout/>
</gsh:script>
